新的架构V3有如下调整：

1. BFF按团队或业务线进行解耦拆分，拆分成若干个BFF微服务，每个业务线可以并行开发和交付各自负责的BFF微服务。

2. 网关（一般由独立框架团队负责运维）专注跨横切面(Cross-Cutting Concerns)的功能，包括：

3. - **路由**，将来自无线设备的请求路由到后端的某个微服务BFF集群。
   - **认证**，对涉及敏感数据的API访问进行集中认证鉴权。
   - **监控**，对API调用进行性能监控。
   - **限流熔断**，当出现流量洪峰，或者后端BFF/微服务出现延迟或故障，网关能够主动进行限流熔断，保护后端服务，并保持前端用户体验可以接受。
   - **安全防爬**，收集访问日志，通过后台分析出恶意行为，并阻断恶意请求。

4. 网关在无线设备和BFF之间又引入了一层间接，让两边可以独立变化，特别是当后台BFF在升级或迁移时，可以做到用户端应用不受影响。

![img](https://img2018.cnblogs.com/i-beta/1263030/202001/1263030-20200105182854259-1866982146.png)

业务在不断发展，技术架构也需要不断的调整来应对需求的变化。近年，A公司技术团队又迎来了新的业务和技术需求，主要是：

1. 开放内部的业务能力，建设A  Open API平台。借助第 三方社区开发者的力量，在A平台上进行创新，进一步拓宽A的应用和业务形态。
2. 废弃传统的服务端Web应用模式，引入前后分离架构，前端采用H5单页等技术给用户提供更好的体验。

为满足业务需求，架构师对服务化架构又进行了拓展升级，新的V4新架构如下图所示：

V4整体思路和V3类似，只是拓展了新的接入渠道:

1. 引入面向第三方开放API的BFF层和配套的网关，支持第三方开发者在CoolShop Open API平台上开发应用。
2. 引入面向H5应用的BFF层和配套的网关，支持前后分离和H5单页应用模式。

V4是一个比较完整的现代微服务架构，从外到内依次分为：端用户体验层->网关层->BFF层->微服务层。整个架构层次清晰，职责分明，是一种灵活的能够支持业务不断创新的演化式架构。